<?xml version="1.0" encoding="utf-8"?>
<guidanceItem id="afda96a3-d516-4acd-904e-54c974d88932" Author="" Category="Input and Data Validation" Priority="1" Rule_Type="Checklist Item" Status="" Technology="ASP.NET 3.5" title="All Output Data is Encoded" Topic="Security" phase="Design" xmlns="urn:microsoft:guidanceexplorer:guidanceItem">
  <content>&lt;h1&gt;What to Check For&lt;/h1&gt;&lt;p&gt;Ensure that input is not echoed back to the user without first validating and/or encoding the data. Data which can be modified by a user must be treated as untrusted data.&lt;/p&gt;&lt;h1&gt;Why&lt;/h1&gt;&lt;p&gt;Echoing input directly back to the user makes your application susceptible to some code injection attacks, such as the &lt;a href="ruledisplay:BC10DCE2-CA48-44BF-8BF6-FEFBE8DCCB7E"&gt;Cross Site Scripting Attack&lt;/a&gt;. What constitutes malicious input varies widely depending on the system in question. On the web, it normally means some kind of JavaScript.&lt;/p&gt;&lt;h1&gt;How to Check&lt;/h1&gt;&lt;p&gt;Use the following steps to ensure that input which can be modified by a user is properly validated and encoded before being echoed back to the user:&lt;/p&gt;&lt;ol&gt;&lt;li&gt;&lt;p&gt;&lt;strong&gt;Identify all sources of user input.&lt;/strong&gt; At design time and again at the code review stage during development, determine all the possible tainted inputs to the application. Determine the intended characteristics of each input (length, format, etc.) and create validators for them. The following list includes some common input sources:&lt;/p&gt;&lt;ul&gt;&lt;li&gt;Form Fields &lt;/li&gt;&lt;li&gt;Query strings &lt;/li&gt;&lt;li&gt;Databases and data access methods &lt;/li&gt;&lt;li&gt;Cookie collection &lt;/li&gt;&lt;li&gt;Session and application variables&lt;/li&gt;&lt;/ul&gt;&lt;/li&gt;&lt;li&gt;&lt;p&gt;&lt;strong&gt;Identify all output that includes user input.&lt;/strong&gt; At design time and again at the code review stage during development, trace all inputs to the system though and determine all of the places where they may be output. In each case, identify the context in which the output occurs.&lt;/p&gt;&lt;/li&gt;&lt;li&gt;&lt;p&gt;&lt;strong&gt;Ensure all user-controllable data is properly encoded before being sent as output.&lt;/strong&gt; In each location where data is output, it must be encoded according the the context of the output.&lt;/p&gt;&lt;ul&gt;&lt;li&gt;Do not rely on the &lt;strong&gt;Server.HtmlEncode&lt;/strong&gt; function to protect your application against cross-site scripting attacks. Instead use the Microsoft Anti-Cross Site Scripting Library available here - &lt;a href="http://www.microsoft.com/downloads/details.aspx?familyid=efb9c819-53ff-4f82-bfaf-e11625130c25&amp;amp;displaylang=en"&gt;http://www.microsoft.com/downloads/details.aspx?familyid=efb9c819-53ff-4f82-bfaf-e11625130c25&amp;amp;displaylang=en&lt;/a&gt;. &lt;/li&gt;&lt;li&gt;Do not attempt to use a character block list; when taking into account Unicode characters, etc., along with new emerging attack forms, block lists are guaranteed to be ineffective. &lt;/li&gt;&lt;li&gt;Ensure that allow list encoding is performed so that all non-alphanumeric characters are encoded instead of certain specific characters like '&amp;lt;', '&amp;gt;, etc. &lt;/li&gt;&lt;li&gt;Encoding must be selected appropriately based upon how the output is returned to the client- either as HTML content or in a URL. Verify the context in which the output is used and ensure it is properly encoded. &lt;/li&gt;&lt;li&gt;If you are using the Microsoft Anti-Cross Site Scripting Library, ensure that the &lt;strong&gt;Microsoft.Security.ApplicationAntiXSSLibrary.HtmlEncode&lt;/strong&gt; method is being used to encode HTML tags and their attributes. Similarly, in case your application constructs certain URLs from input data or data from a shared database, ensure that the &lt;strong&gt;Microsoft.Security.ApplicationAntiXSSLibrary.UrlEncode&lt;/strong&gt; method is being used to make them safe. &lt;/li&gt;&lt;li&gt;Make sure that you encode data at the last possible opportunity before the data is returned to the client. If you encode any earlier than this, you may not know the exact context that the data will be used in, and hence the format you need to encode into. Also, early encoding of some data can result in double encoding problems.&lt;/li&gt;&lt;/ul&gt;&lt;/li&gt;&lt;/ol&gt;&lt;p&gt;If data is being written out into an HTML context, the following code will ensure that only known safe characters get through and guard against all possible XSS attacks. It will increase the size of the resulting HTML and does require more processing overhead, but it is definitely safe:&lt;/p&gt;&lt;pre&gt;public static string HtmlEncode(string x){&lt;br&gt;  if (x == null)&lt;br&gt;  {&lt;br&gt;      return x;&lt;br&gt;  }&lt;br&gt;  return Regex.Replace(x, "[^a-zA-Z0-9]+", new MatchEvaluator(WebUtility.EncodeMatch));&lt;br&gt;}&lt;/pre&gt;&lt;h1&gt;Problem Example&lt;/h1&gt;&lt;p&gt;As it uses user input directly from the query string, the following ASP.NET code is vulnerable:&lt;/p&gt;&lt;pre&gt;&amp;lt;img id='img&amp;lt;%=Server.HtmlEncode(Request.QueryString["userId"]) %&amp;gt;' src='/image.gif' /&amp;gt;&lt;/pre&gt;&lt;p&gt;Since this page does not encode the output which depends upon the user supplied query string parameter &lt;strong&gt;userID&lt;/strong&gt;, malicious user input will lead to cross site scripting attacks.&lt;/p&gt;&lt;p&gt;&lt;strong&gt;Note:&lt;/strong&gt; While simple XSS attacks will not work for this webpage as ASP.NET enables request validation by default, many more complex attack will be successful. Read more about this problem here: &lt;a href="ruledisplay:DD60FFDF-904D-45A8-8278-F3E8CEBA911F"&gt;Do Not Rely on Request Validation&lt;/a&gt;.&lt;/p&gt;&lt;h1&gt;Additional Resources&lt;/h1&gt;&lt;ul&gt;&lt;li&gt;&lt;a href="http://msdn2.microsoft.com/en-us/library/ms998274.aspx"&gt;How To: Prevent Cross-Site Scripting in ASP.NET&lt;/a&gt; &lt;/li&gt;&lt;li&gt;Download the Microsoft Anti-Cross Site Scripting Library here &lt;a href="http://www.microsoft.com/downloads/details.aspx?familyid=efb9c819-53ff-4f82-bfaf-e11625130c25&amp;amp;displaylang=en"&gt;http://www.microsoft.com/downloads/details.aspx?familyid=efb9c819-53ff-4f82-bfaf-e11625130c25&amp;amp;displaylang=en&lt;/a&gt;&lt;/li&gt;&lt;/ul&gt;&lt;h1&gt;Related Guideline&lt;/h1&gt;&lt;ul&gt;&lt;li&gt;&lt;a href="ruledisplay:1AB38C50-F31D-4CD8-89B1-CE397E6895E8"&gt;Guideline: Encode All Output Data (ASP.NET)&lt;/a&gt; &lt;/li&gt;&lt;/ul&gt;&lt;hr&gt;&lt;p&gt;Adapted from Microsoft patterns &amp;amp; practices guidance. &lt;/p&gt;</content>
</guidanceItem>