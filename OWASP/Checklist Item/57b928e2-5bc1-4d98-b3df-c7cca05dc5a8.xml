<?xml version="1.0" encoding="utf-8"?>
<guidanceItem id="57b928e2-5bc1-4d98-b3df-c7cca05dc5a8" Author="" Category="Unmanaged Code" Priority="2" Rule_Type="Checklist Item" Status="" Technology="Java" title="All Data Passed Between Native and Java Code is Validated" Topic="Security" phase="Implementation" xmlns="urn:microsoft:guidanceexplorer:guidanceItem">
  <content>&lt;h1&gt;What to Check For&lt;/h1&gt;&lt;p&gt;Verify that your application validates all data that is passed between Java code and native code.&lt;/p&gt;&lt;h1&gt;Why&lt;/h1&gt;&lt;p&gt;Unchecked input and/or output can lead to buffer overflows, injection based attacks such as SQL injection, cross-site scripting, etc., that exploit weaknesses in the application.&lt;/p&gt;&lt;h1&gt;How to Check&lt;/h1&gt;&lt;p&gt;Due to the security risk posed by the use of native code, verify that your application validates data that is passed between native code and Java:&lt;/p&gt;&lt;ol&gt;&lt;li&gt;&lt;p&gt;&lt;strong&gt;Check if language boundaries are clearly defined. &lt;/strong&gt;If your Java application needs to use native code, ensure that you have identified all the locations where the Java code interacts with native code. As your application moves between Java code and native code, special attention needs to be given to error handling routines, so that no security holes are introduced in your application by its native component.&lt;/p&gt;&lt;/li&gt;&lt;li&gt;&lt;p&gt;&lt;strong&gt;Verify the quality of your application's validators. &lt;/strong&gt;Using the &lt;a href="ruledisplay:6D944640-22E7-421F-8192-45730D5118AB"&gt;Input is Validated for Length, Range, Format and Type&lt;/a&gt; checklist, verify that your application's data is properly validated for length, range, format and type.&lt;/p&gt;&lt;/li&gt;&lt;li&gt;&lt;p&gt;&lt;strong&gt;Verify that all data is validated. &lt;/strong&gt;Using the &lt;a href="ruledisplay:178EB28D-4F49-4476-AE8A-437F966DE577"&gt;Input from All Sources is Validated&lt;/a&gt; checklist, verify that all data passing through the locations identified in Step 1 is validated.&lt;/p&gt;&lt;/li&gt;&lt;li&gt;&lt;p&gt;&lt;strong&gt;Ensure that data validation code is centralized. &lt;/strong&gt;It is better that all validation routines in your application are centralized for cleaner and better control. Shared validation routines are better than creating many spread throughout your application's code base. Every time your application accepts external data as input, it should first pass through this set of validation routines.&lt;/p&gt;&lt;/li&gt;&lt;/ol&gt;&lt;h1&gt;Problem Example&lt;/h1&gt;&lt;p&gt;The following segment shows a JNI code that utilizes a COM object. Making the assumption that the Java code will handle data validation, the JNI segment does not verify that the passed input is a valid GUID. Since invalid GUIDs may cause unhandled exceptions, an attacker can force the application to disclose its call stack and possibly its source filenames.&lt;/p&gt;&lt;blockquote&gt;&lt;pre&gt;#include &amp;lt;jni.h&amp;gt;&lt;br&gt;#include &amp;lt;sys/types.h&amp;gt;&lt;br&gt;#include &amp;lt;fcntl.h&amp;gt;&lt;br&gt;#include &amp;lt;stdio.h&amp;gt;&lt;br&gt;#include &amp;lt;atlbase.h&amp;gt;&lt;br&gt;#include &amp;lt;windows.h&amp;gt;&lt;br&gt;#include &amp;lt;wtypes.h&amp;gt;&lt;br&gt;JNIEXPORT jboolean&lt;br&gt;JNICALL Java_Identifier_invokeObject&lt;br&gt;       (JNIEnv * env, jobject jobj, jstring jguid)&lt;br&gt;{&lt;br&gt;      HRESULT result;&lt;br&gt;      CLSID clsid;&lt;br&gt;      IUnknown *pIunkn;&lt;br&gt;      LPWSTR guid;&lt;br&gt;      jboolean iscopy;&lt;br&gt;      jboolean ret = false;&lt;br&gt;      char* temp_guid = (*env)-&amp;gt;GetStringUTFChars(env, jguid, &amp;amp;iscopy);&lt;br&gt;      //The application fails to verify that the GUID is valid&lt;br&gt;      guid = SysAllocStringLen(0, 38);&lt;br&gt;      MultiByteToWideChar(CP_ACP, 0, temp_guid, -1, guid, 38);&lt;br&gt;      result = GUIDFromString(guid, &amp;amp;clsid);&lt;br&gt;       ...&lt;br&gt;      return ret;&lt;br&gt;}&lt;/pre&gt;&lt;/blockquote&gt;&lt;h1&gt;Additional Resources&lt;/h1&gt;&lt;ul&gt;&lt;li&gt;For more information about the security issues that JNI introduces, see: &lt;a href="http://www.owasp.org/index.php/Unsafe_JNI"&gt;Unsafe JNI&lt;/a&gt; from OWASP. &lt;/li&gt;&lt;/ul&gt;&lt;h1&gt;Related Guideline&lt;/h1&gt;&lt;ul&gt;&lt;li&gt;&lt;a href="ruledisplay:42F599F0-D1D6-4F25-9CC2-D5473F19113F"&gt;Guideline: Validate All Data Passed Between Native and Java Code (Java Web Application)&lt;/a&gt; &lt;/li&gt;&lt;/ul&gt;</content>
</guidanceItem>