<?xml version="1.0" encoding="utf-8"?>
<guidanceItem id="1c6916b0-53e4-45a1-804a-0ab1173b3b6b" Author="" Category="Data Access" Priority="2" Rule_Type="Checklist Item" Status="" Technology="Java" title="Type Safe SQL Parameters are Used" Topic="Security" phase="Implementation" xmlns="urn:microsoft:guidanceexplorer:guidanceItem">
  <content>&lt;h1&gt;What to Check For&lt;/h1&gt;&lt;p&gt;Ensure that type safe SQL parameters are used when performing database transactions.&lt;/p&gt;&lt;h1&gt;Why&lt;/h1&gt;&lt;p&gt;Attackers can use a &lt;a href="ruledisplay:1D4FA7AF-33F0-40D9-9665-A31DBF3D7764"&gt;SQL Injection Attack&lt;/a&gt; to manipulate the database in unforeseen ways. SQL injection allows an attacker to assume the credentials of the SQL account used to connect to the database, which may lead to arbitrary reading, writing, updating or deleting of data. In an improperly secured database, this can also lead to remote code execution through the use of certain stored procedures that allow for direct Operating System command injection.&lt;/p&gt;&lt;h1&gt;How to Check&lt;/h1&gt;&lt;p&gt;To check if parameterized queries are used:&lt;/p&gt;&lt;ol&gt;&lt;li&gt;&lt;p&gt;&lt;strong&gt;Identify all database transactions. &lt;/strong&gt;Locate all SQL queries throughout your application. Example:&lt;/p&gt;&lt;blockquote&gt;&lt;pre&gt;"select user from myappUsers where user = ? and pass = ?;"&lt;/pre&gt;&lt;/blockquote&gt;&lt;/li&gt;&lt;li&gt;&lt;p&gt;&lt;strong&gt;Verify that each transaction uses Stored Procedures. &lt;/strong&gt;Verify that your application interacts with the backend database through the use of Stored Procedures. Ensure that all SQL queries look like:&lt;/p&gt;&lt;blockquote&gt;&lt;pre&gt;Connection.prepareStatement("exec PlaceOrder(?, ?, ?);");&lt;/pre&gt;&lt;/blockquote&gt;&lt;p&gt;and not like:&lt;/p&gt;&lt;blockquote&gt;&lt;pre&gt;Connection.prepareStatement("insert into PendingPurchases "&lt;br&gt;                          + "(customer, item, quantity) values (?, ?, ?);");&lt;/pre&gt;&lt;/blockquote&gt;&lt;/li&gt;&lt;li&gt;&lt;p&gt;&lt;strong&gt;Verify that each transaction uses Prepared Statement. &lt;/strong&gt;Verify that each SQL query is executed through the use of a PreparedStatement object. Example:&lt;/p&gt;&lt;blockquote&gt;&lt;pre&gt;Connection cn = MyApp.getDBConnection();&lt;br&gt;PreparedStatement st = cn.prepareStatement("select user from myappUsers where user = ? and pass = ?;");&lt;br&gt;st.setString(1, user);&lt;br&gt;st.setString(2, new String(passDigest));&lt;br&gt;ResultSet rs = st.executeQuery();&lt;/pre&gt;&lt;/blockquote&gt;&lt;/li&gt;&lt;/ol&gt;&lt;h1&gt;Problem Example&lt;/h1&gt;&lt;p&gt;The following code validates the user based on a given username and password. It hashes the password with a random salt. Then it compares the username and the produced hash against the data stored in the backend database. Unfortunately, the SQL query is dynamically crafted by using the user's input. If there is no proper input validation, an attacker can access the application's database server through the use of SQL injection.&lt;/p&gt;&lt;blockquote&gt;&lt;pre&gt;public boolean validateUser(String user, char[] pass)&lt;br&gt;{&lt;br&gt;      // Hash the credentials before querying the credential store&lt;br&gt;      // The application crafts the SQL query based on user's input&lt;br&gt;      Connection cn = MyApp.getDBConnection();&lt;br&gt;      Statement st = cn.createStatement();&lt;br&gt;      String query = "select login_attempts from myappUsers where user = \""&lt;br&gt;                    + user + "\" and pass = \"" + passHash + "\";";&lt;br&gt;      ResultSet rs = st.executeQuery(query);&lt;br&gt;      // Execute the rest of the authentication steps&lt;br&gt;}&lt;/pre&gt;&lt;/blockquote&gt;&lt;h1&gt;Additional Resources&lt;/h1&gt;&lt;ul&gt;&lt;li&gt;To learn more about using parameterized queries in Java, see: &lt;a href="http://java.sun.com/j2se/1.4.2/docs/api/java/sql/PreparedStatement.html"&gt;PreparedStatement&lt;/a&gt;. &lt;/li&gt;&lt;li&gt;For more information about preventing SQL injection attacks, visit: &lt;a href="http://www.owasp.org/index.php/Reviewing_Code_for_SQL_Injection"&gt;Reviewing Code for SQL Injection&lt;/a&gt;&amp;nbsp;from OWASP. &lt;/li&gt;&lt;/ul&gt;&lt;h1&gt;Related Guideline&lt;/h1&gt;&lt;ul&gt;&lt;li&gt;&lt;a href="ruledisplay:9DF701E2-7929-4533-9DC3-368AAC4E553D"&gt;Guideline: Use Type Safe SQL Parameters When Constructing SQL Queries (Java Web Application)&lt;/a&gt; &lt;/li&gt;&lt;li&gt;&lt;a href="ruledisplay:ADE80907-B490-4FD3-81A8-826117E25662"&gt;Guideline: Use Stored Procedures (Java Web Application)&lt;/a&gt; &lt;/li&gt;&lt;/ul&gt;</content>
</guidanceItem>